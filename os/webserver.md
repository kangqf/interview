## webserver IO 策略
服务器[处理请求](http://www.kegel.com/c10k.html)（[译文](http://www.cnblogs.com/fll/archive/2008/05/17/1201540.html)）的模型迭代了很多代，单机的并发处理能力也得到了极大的提升。那么现在的webserver 到底是怎么实现的呢？

对于webserver 来说能够稳定地处理大量的并发连接是服务器程序最重要的性能指标，由于操作系统任务处理和I/O模型的限制，我们可用的网络服务器模型是有限的。不同的服务模型可以应对不同的环境，具有不同的优点和缺点。

从操作系统任务处理的角度来看，有三种服务器模型可选：

* 多进程模型
* 多线程模型
* （单线程）异步模型


从I/O模型的角度来看，最常用的网络服务器模型有：

* 单线程阻塞I/O模型
* 多线程阻塞I/O模型
* 单线程非阻塞I/O模型（包括非阻塞I/O,I/O复用）
* 单线程异步I/O模型


处理大量连接的时候，基于不同I/O策略的模型具有不同的资源（尤其是RAM和CPU）消耗和限制。

* 单线程阻塞I/O模型：最简单的模型，计算机网络发展早期使用的解决方案。也是我们学习网络编程时首先接触的例子。它使用循环的方式，遍历处理所有的连接。这种方式的问题显而易见，随着连接数的增加，低效又缓慢。

* 多线程阻塞I/O模型：这是利用多线程对 单线程阻塞I/O模型 的改进，每个线程负责监听处理一个连接。随之而来的问题是，开启销毁线程的高昂代价：线程栈对内存的需求，线程切换对CPU的需求，频繁线程切换造成的不稳定（线程抖动）。

* 单线程非阻塞I/O模型：与 单线程阻塞I/O模型 类似，循环遍历处理所有连接。只是由于非阻塞I/O的特点，内核没有可用数据时立即返回，不会阻塞线程。这样的循环轮询容易大幅度推高CPU的占用率，因此一般我们不会使用这种方式，而是引入I/O复用，当没有可用数据时将线程阻塞在代理（select/poll/epoll）调用上，占用较少的CPU资源。

* 单线程异步I/O模型：基于异步I/O的模型。

### 5种最流行的IO策略
1. 单线程并发非阻塞水平触发IO
2. 单线程并发非阻塞边沿触发IO
3. 单线程并发异步IO
4. 多线程并发阻塞IO
5. 把应用层代码放进内核中

### Swoole
异步非阻塞，2.0开始天生支持协程骚操作。

### Apache
Apache有三种工作模块，分别为prefork、worker、event。
* prefork：多进程，该模式apache会预先创建一部分空闲的进程，每个请求用一个进程响应，这个过程会用到select机制来通知。该模式下一个进程只能处理一个用户的请求
* worker：多线程，一个进程可以生成多个线程，每个线程响应一个请求，但通知机制还是select不过可以接受更多的请求。说该模式下一个进程可能会处理多个用户的请求，该模式有线程安全问题。该模式用的内存会小一点，因为线程之间的内存是大部分共享的而进程间的内存大多是独立的。
* event：基于异步I/O模型，一个进程或线程，每个进程或线程响应多个用户请求，它是基于事件驱动（也就是epoll机制）实现的

### Nginx
Nginx 三大特点： 事件驱动  异步  非阻塞

Nginx 不会为每个请求创建一个新的进程，用户可以配置Nginx工作的进程的数量，一般来说这个数量是和CPU的核的数量是一致的。并且对于每个进程，Nginx只为其维护一个线程。其中每个工作进程可以处理数千个并发的请求，它通过一个线程来完成这些工作。

#### Nginx 与惊群
多线程/多进程（linux下线程进程也没多大区别）等待同一个socket事件，当这个事件发生时，这些线程/进程被同时唤醒，就是惊群。许多进程被内核重新调度唤醒，同时去响应这一个事件，当然只有一个进程能处理事件成功，其他的进程在处理该事件失败后重新休眠（也有其他选择）。这种性能浪费现象就是惊群。


在linux2.6内核上，accept系统调用已经不存在惊群了，当新连接过来时，大家会发现，仅有一个子进程返回新建的连接，其他子进程继续休眠在accept调用上，没有被唤醒。

但是IO多路复用的引入又重新触发了这个现象，如果我们在子进程内不是阻塞调用accept，而是用`epoll_wait`，就会发现，新连接过来时，多个子进程都会在`epoll_wait`后被唤醒！

nginx对惊群的处理方式是：在linux上默认就封装了epoll_wait调用，使得同一时刻只允许一个nginx worker在自己的epoll中处理监听句柄。

参考[基于不同I/O策略的服务器模型](http://strawhatfy.github.io/2015/04/22/IO-strategies-server/)